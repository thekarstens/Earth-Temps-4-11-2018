<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>Apr 2018 Case Study – METAR + Wind Arrows + Daily Particles + Alerts</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- Local Leaflet in your repo -->
<link rel="stylesheet" href="./leaflet.css"/>
<script src="./leaflet.js"></script>

<!-- Leaflet Velocity (WORKING CDN) -->
<link rel="stylesheet" href="https://unpkg.com/leaflet-velocity@2.1.4/dist/leaflet-velocity.css"/>
<script src="https://unpkg.com/leaflet-velocity@2.1.4/dist/leaflet-velocity.js"></script>

<style>html, body { height:100%; margin:0; }
  #map { height:100%; background:#fff; }

  .panel{ top: 110px;

    position:absolute; top:10px; left:10px; z-index:9999;
    background:rgba(255,255,255,0.95);
    border:1px solid #ccc; border-radius:12px;
    padding:10px;
    font:600 12px/1.2 Arial, sans-serif;
    box-shadow: 0 2px 10px rgba(0,0,0,.10);
    min-width: 330px;
  }
  .row{ display:flex; gap:8px; align-items:center; margin-top:8px; flex-wrap:wrap; }
  .btn{
    border:1px solid #333; background:#fff; border-radius:10px;
    padding:6px 10px; cursor:pointer; font:700 12px Arial;
  }
  .btn:active{ transform: translateY(1px); }
  .mono{ font-family: ui-monospace, Menlo, Consolas, monospace; font-weight:800; }

  .dot{
    border-radius:50%;
    border:2px solid #333;
    display:flex;align-items:center;justify-content:center;
    font:800 12px/1 Arial, sans-serif;color:#111;
    box-shadow: 0 1px 3px rgba(0,0,0,.25);
    user-select:none;
  }

  .swatch {
    display:inline-block;
    width:12px; height:12px;
    border:1px solid #333;
    border-radius:2px;
    vertical-align:middle;
    margin-right:6px;
  }

  .tiny {
    font:600 11px/1.2 Arial, sans-serif;
    opacity:.78;
  }

/* Observed radar styling */
.obs-radar { filter: brightness(1.22) contrast(1.08) saturate(1.05); mix-blend-mode: multiply; }

/* ===== Imported master banner + city label styles from index (15) ===== */
/* Top TV-style banner */
  .tvbanner{
    position:absolute; top:0; left:0; right:0;
    z-index:99999;
    background:rgba(11,28,45,0.94);
    color:#fff;
    font:900 26px/1.1 Arial, sans-serif;
    letter-spacing:0.8px;
    padding:14px 18px;
    border-bottom:2px solid rgba(255,255,255,0.12);
    text-transform:uppercase;
    pointer-events:none;
  }

/* Branding logo (bottom-right, small) */
  #brandLogo{
    position:absolute;
    bottom:6px;
    right:10px;
    z-index:100000;
    width:140px;
    max-width:24vw;
    height:auto;
    opacity:0.95;
    filter: drop-shadow(0 2px 6px rgba(0,0,0,0.25));
    pointer-events:none;
  }

/* Leaflet layer control nudge down below banner */
  :root{ --banner-offset: 70px; }
.leaflet-top.leaflet-right{ top: var(--banner-offset); }
.leaflet-top.leaflet-left{ top: var(--banner-offset); }

/* Simple town label style */
  .town-label{
    background: rgba(255,255,255,0.75);
    border:1px solid rgba(0,0,0,0.25);
    padding:2px 6px;
    border-radius:10px;
    font:800 11px/1 Arial, sans-serif;
    box-shadow: 0 1px 4px rgba(0,0,0,.15);
  }

/* --- Banner layout + controls --- */
.tvbanner{height:76px;padding:10px 14px;pointer-events:auto;}

.banner-inner{height:100%;display:flex;align-items:center;gap:16px;}

.banner-title{font-size:34px;font-weight:900;letter-spacing:1px;white-space:nowrap;text-transform:uppercase;}

.banner-controls{display:flex;align-items:center;gap:10px;margin-left:10px;}

.bbtn{pointer-events:auto;border:1px solid rgba(255,255,255,0.35);background:rgba(0,0,0,0.25);color:#fff;
  padding:6px 10px;border-radius:10px;font-weight:800;cursor:pointer;line-height:1;}

.bbtn:hover{background:rgba(0,0,0,0.4);}

.btime{min-width:190px;text-align:center;font-weight:800;letter-spacing:.2px;}

.banner-actions{margin-left:auto;display:flex;align-items:center;gap:10px;}

#brandLogo{
  position:absolute;right:18px;bottom:6px;width:210px;z-index:900;pointer-events:none;
  filter: drop-shadow(0 3px 10px rgba(0,0,0,.35));
}

/* --- layout tweaks --- */
  .leaflet-top.leaflet-right{ margin-top: 90px; }

/* push layer toggles below banner */
  #brandLogo{ bottom: 26px; right: 26px; }

/* --- Banner: simple classroom layout --- */
.tvbanner{height:auto; padding:10px 14px; pointer-events:auto;}

.banner-inner{display:flex; align-items:center; gap:14px;}

.banner-left{display:flex; align-items:center; gap:12px; min-width:340px;}

.bbtn-story{font:900 14px/1 Arial, sans-serif; padding:10px 12px; border-radius:12px; background:rgba(255,255,255,0.10);}

.bbtn-story:hover{background:rgba(255,255,255,0.18);}

.banner-mid{display:flex; align-items:center; gap:10px;}

.btime{min-width:230px; text-align:center; font:900 14px/1 Arial, sans-serif; letter-spacing:.3px;}

.banner-right{margin-left:auto; display:flex; align-items:center; gap:10px;}

.product-right{font:900 32px/1 Arial, sans-serif; letter-spacing:1px; text-transform:uppercase; padding-left:10px; border-left:1px solid rgba(255,255,255,0.25);}

.leg-mini-label{font:900 11px/1 Arial, sans-serif; opacity:.92; text-transform:uppercase; letter-spacing:.4px;}

.leg-mini-bar{display:inline-block; width:110px; height:10px; border-radius:6px; background: linear-gradient(90deg, #2b83ba, #4ecdc4, #a8e6a3, #ffd166, #ef476f); box-shadow: inset 0 0 0 1px rgba(255,255,255,0.18);}

.opacity-wrap{display:flex; align-items:center; gap:8px; padding:6px 10px; border-radius:12px; border:1px solid rgba(255,255,255,0.25); background:rgba(0,0,0,0.18);}

.op-label{font:900 11px/1 Arial, sans-serif; opacity:.92; text-transform:uppercase; letter-spacing:.4px;}

#radarOpacity{width:120px;}

/* --- Begin story: big + obvious (yellow) --- */
.bbtn-story{
  background:#fdd835 !important;
  color:#111 !important;
  border-color: rgba(0,0,0,0.35) !important;
  font:900 14px/1 Arial,sans-serif !important;
  padding:12px 14px !important;
  border-radius:14px !important;
  letter-spacing:.8px !important;
}

.bbtn-story:hover{filter:brightness(0.96)}

/* --- Product center --- */
.banner-product{display:flex;align-items:center;justify-content:center;min-width:240px}

.product-center{
  font:900 42px/1 Arial,sans-serif;
  letter-spacing:1px;
  text-transform:uppercase;
  padding:0 10px;
  white-space:nowrap;
}

/* Logo down a bit */
#brandLogo{bottom:6px !important; right:26px !important;}

/* --- Option-2 style driving question block --- */
.banner-left{display:flex;flex-direction:column;gap:2px;min-width:420px;max-width:44vw}

.banner-mid-stack{gap:10px}

/* Give the product a little breathing room */
.banner-product{margin:0 6px}

/* --- Banner alignment fix: pull legend/controls back up --- */
.banner-inner{align-items:flex-start}

.opacity-wrap{margin-top:0}

/* --- Restore "like before" banner geometry --- */
.banner-inner{position:relative; align-items:center !important;}

.legend-mini, .opacity-wrap{margin-top:0 !important;}

/* Logo lower */
#brandLogo{bottom:0px !important;}

/* --- Two-line banner layout --- */
.tvbanner{
  position:absolute; top:0; left:0; right:0;
  z-index:99999;
  background:rgba(11,28,45,0.90);
  color:#fff;
  border-bottom:2px solid rgba(255,255,255,0.12);
}

.banner-topline{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:12px;
  padding:10px 14px 6px 14px;
  font-family: Arial, sans-serif;
  text-transform:uppercase;
  letter-spacing:.7px;
}

.top-lesson{font-weight:900;font-size:26px;white-space:nowrap}

.top-sep{opacity:.65;font-weight:900}

.top-question{font-weight:800;font-size:16px;letter-spacing:.2px;text-transform:none;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:100%;flex:1 1 100%;text-align:center}

.top-q-label{font-weight:900;text-transform:uppercase;letter-spacing:.6px}

.banner-bottomline{
  display:flex;
  justify-content:center;
  padding:6px 14px 10px 14px;
  font-family: Arial, sans-serif;
}

/* Big product word, flexible */
.banner-product{min-width:200px;display:flex;justify-content:center}

.product-center{
  font:900 44px/1 Arial,sans-serif;
  letter-spacing:1px;
  text-transform:uppercase;
  white-space:nowrap;
}

.time-controls{display:flex;align-items:center;gap:10px}

.btime{font:900 16px/1 Arial,sans-serif;letter-spacing:.7px;text-transform:uppercase;white-space:nowrap}

/* Begin button */
.bbtn-story{
  background:#fdd835 !important;
  color:#111 !important;
  border-color: rgba(0,0,0,0.35) !important;
  font:900 14px/1 Arial,sans-serif !important;
  padding:12px 16px !important;
  border-radius:14px !important;
  letter-spacing:.8px !important;
}

/* Opacity group */
.opacity-wrap{display:flex;align-items:center;gap:8px}

.op-label{font:900 12px/1 Arial,sans-serif;letter-spacing:.7px;text-transform:uppercase}

#radarOpacity{width:180px}

/* Map legend near logo */
.map-legend{
  position:absolute;
  right:190px;
  bottom:26px;
  z-index:900;
  background:rgba(11,28,45,0.80);
  border:1px solid rgba(255,255,255,0.18);
  border-radius:12px;
  padding:8px 10px;
  color:#fff;
  font-family: Arial, sans-serif;
}

.map-legend-row{display:flex;align-items:center;gap:10px}

.leg-mini-label{font:900 12px/1 Arial,sans-serif;letter-spacing:.7px;text-transform:uppercase;opacity:.95}

.leg-mini-bar{
  width:140px;height:10px;border-radius:7px;
  background:linear-gradient(90deg,#2b83ba,#ffd166,#ef476f);
}

/* Keep logo low */
#brandLogo{bottom:0px !important; right:26px !important;}

/* --- Brand color stripes (from Weather Workshops logo) --- */
.tvbanner{ position:absolute; }

.tvbanner::before{
  content:"";
  position:absolute;
  top:0; left:0; right:0;
  height:4px;
  background:#2f4e94;
}

.tvbanner{position:absolute; top:0; left:0; right:0; z-index:99999; }

.banner-topline{
  display:flex;
  align-items:center;
  justify-content:center;
  gap:14px;
  padding:14px 14px 8px 14px;
  font-family: Arial, sans-serif;
  text-transform:uppercase;
  letter-spacing:.7px;
  position:relative;
}

.banner-topline .topline-center{
  flex:1;
  display:flex;
  align-items:baseline;
  gap:10px;
  max-width:1200px;
  justify-content:center;
  flex-wrap:wrap;
  padding-right:190px; /* reserve space so button doesn't overlap text */
}

.banner-topline .bbtn-story{
  position:absolute;
  right:14px;
  top:10px;
}

.banner-bottomline{padding:6px 14px 12px 14px;}

.map-legend{
  right:12px !important;
  bottom:70px !important;
  padding:7px 9px !important;
  border-radius:12px !important;
}

.leg-mini-bar{width:120px !important;}

#brandLogo{bottom:0px !important; right:14px !important;}

/* Pin START button in top-right of the top banner line */
.banner-topline{position:relative !important;}

.banner-topline > .bbtn-story{
  position:absolute !important;
  right:14px !important;
  top:10px !important;
}

/* Orange divider line in the middle (between top line and controls line) */
.banner-divider{
  height:3px;
  width:100%;
  background:#eab35b; /* brand orange */
  opacity:0.95;
}

/* Nudge legend tighter into the corner */
.map-legend{right:10px !important; bottom:62px !important;}

/* Force START button to upper-right corner */
.banner-topline{
  position:relative !important;
}

.banner-topline .bbtn-story{
  position:absolute !important;
  right:16px !important;
  top:50% !important;
  transform:translateY(-50%) !important;
}

/* --- FINAL banner alignment fixes --- */

/* True center for top line text */
.banner-topline{
  display:flex !important;
  align-items:center !important;
  justify-content:center !important;
}

.banner-topline .topline-center{
  margin:0 auto !important;
  text-align:center !important;
  padding-right:0 !important;
}

/* Force START button to true upper-right corner */
.banner-topline .bbtn-story{
  position:absolute !important;
  right:16px !important;
  top:12px !important;
  transform:none !important;
}

/* Center RADAR on second row */
.banner-bottomline{
  display:flex !important;
  justify-content:center !important;
}

.banner-product{
  margin:0 auto !important;
}

.product-center{
  text-align:center !important;
}

/* --- Pin START button to upper-right (top line) --- */
.banner-topline{position:relative !important;}

.banner-topline #beginStoryBtn{
  position:absolute !important;
  right:16px !important;
  top:10px !important;
  transform:none !important;
}

/* --- Push logo slightly LOWER than the bottom edge (so it "sits lower") --- */
#brandLogo{
  bottom:-12px !important;
  right:10px !important;
}

/* Slightly tighter banner height (small) */
.banner-topline{padding-top:8px !important; padding-bottom:5px !important;}

.banner-bottomline{padding-top:3px !important; padding-bottom:7px !important;}

/* --- Slight banner shrink (top text + controls) --- */
.top-lesson{font-size:22px !important;}

.top-question{font-size:14px !important;}

.product-center{font-size:38px !important;}

.bbtn{padding:7px 10px !important; font-size:12px !important;}

.bbtn-story{padding:10px 14px !important; font-size:13px !important;}

#radarOpacity{width:160px !important;}

.banner-topline{padding-top:7px !important; padding-bottom:4px !important;}

.banner-bottomline{padding-top:2px !important; padding-bottom:6px !important;}

/* --- Brand logo: smaller + lower --- */
#brandLogo{
  width:150px !important;
  height:auto !important;
  bottom:-24px !important;
  right:10px !important;
  opacity:0.95 !important;
}

/* TV-style city labels */
.leaflet-tooltip.tv-city-label{
  background:rgba(255,255,255,0.94);
  color:#111;
  border:0;
  border-radius:10px;
  padding:4px 8px;
  box-shadow:0 2px 10px rgba(0,0,0,0.25);
  font:800 12px/1 Arial,sans-serif;
}

/* --- Banner bottom row: force single-line layout --- */
.banner-bottomline{
  flex-wrap: nowrap !important;
  justify-content: space-between !important;
  gap: 12px !important;
}
#modeBtn{ flex: 0 0 auto; }
.opacity-wrap{ flex: 0 1 240px; min-width: 180px; }
.product-center{
  flex: 1 1 auto;
  min-width: 120px;
  white-space: nowrap;
  line-height: 1;
}
.time-wrap{
  flex: 0 0 auto;
  display: flex;
  align-items: center;
  gap: 10px;
  white-space: nowrap;
}
.btime{ white-space: nowrap; }
.banner-zoom{ flex: 0 0 auto; }

/* Tighten fonts a bit so everything fits under the yellow line */
.product-center{ font-size: 46px !important; }
.btime{ font-size: 22px !important; }

/* Responsive: on narrower screens, shrink more but keep one line */
@media (max-width: 1100px){
  .product-center{ font-size: 38px !important; }
  .btime{ font-size: 18px !important; }
  .opacity-wrap{ flex-basis: 200px; min-width: 150px; }
}
@media (max-width: 900px){
  .product-center{ font-size: 30px !important; }
  .opacity-wrap{ display: none; } /* last resort: hide opacity slider on very small widths */
}


/* --- Mobile banner tightening --- */
@media (max-width: 600px){
  :root{ --banner-offset: 110px; }
  .tvbanner{ padding:6px 10px; }
  .banner-inner{ flex-wrap:wrap; gap:8px; }
  .banner-title{ font-size:22px; }
  .banner-product{ min-width:unset; }
  .banner-left{ min-width:unset; max-width:100%; }
  .banner-right{ width:100%; margin-left:0; justify-content:flex-end; }
  .questionbar{ font-size:12px; }
}

</style>
</head>

<body>

<div id="banner" class="tvbanner">
  <div class="banner-topline" role="banner">
    <div class="topline-center">
      <span class="top-lesson">Lesson: METAR Analysis</span>
      <span class="top-sep">—</span>
      <span class="top-question"><span class="top-q-label">Question:</span> How can we use real-time weather data to make safer decisions?</span>
    </div>
<button class="bbtn bbtn-story" id="beginStoryBtn" title="Begin the guided story">START</button>
  </div>
  <div class="banner-divider" aria-hidden="true"></div>

  <div class="banner-bottomline">
    <div class="bottomline-center">
<button class="bbtn" id="modeBtn" title="Toggle Student / Teacher mode">STUDENT</button>

      <div class="opacity-wrap" title="Opacity">
        <span class="op-label">Opacity</span>
        <input id="radarOpacity" type="range" min="20" max="100" value="70" />
      </div>

      <div class="banner-product" aria-label="Product shown">
        <div class="product-center" id="productLabel">METARS</div>
      </div>

      <div class="time-controls" aria-label="Time controls">
        <button class="bbtn" id="backBtnBanner" title="Back 3 hours">◀</button>
        <div class="btime" id="bannerTimeLabel">April 14, 2018 7AM</div>
        <button class="bbtn" id="fwdBtnBanner" title="Forward 3 hours">▶</button>
      </div>

      <button class="bbtn" id="zoomOutBtnBanner" title="Zoom out">−</button>
      <button class="bbtn" id="zoomInBtnBanner" title="Zoom in">+</button>
    </div>
  </div>

  <div id="status" class="bstatus" style="display:none;"></div>
</div>

<img id="brandLogo" src="./logo.png" alt="Weather Workshops" />

<div id="map"></div>

<div class="panel">
  <div style="font-size:13px;margin-bottom:6px">Apr 2018 Case Study</div>

  <!-- Time controls for METAR + Alerts -->
  <div class="row">
    <button class="btn" id="backBtn">◀ Time</button>
    <div class="mono" id="timeLabel">2018-04-14 15Z</div>
    <button class="btn" id="fwdBtn">Time ▶</button>
  </div>

  <!-- Day controls for PARTICLES ONLY -->
  <div class="row">
    <span class="tiny">Particles day:</span>
    <button class="btn" id="dayBackBtn">◀ Apr 13</button>
    <div class="mono" id="dayLabel">Apr 14</div>
    <button class="btn" id="dayFwdBtn">Apr 15 ▶</button>
  </div>

  <div class="row">
    <span style="opacity:.75">Step:</span>
    <span class="mono">3 hours</span>
    <span style="opacity:.75;margin-left:auto">Zoom:</span>
    <span class="mono" id="zoomLabel">6</span>
  </div>

  <div class="row">
    <span class="tiny" id="status">Loading…</span>
  </div>

  <div class="tiny">
    Wind arrows: direction wind is blowing <b>TO</b> (METAR direction + 180°).
  </div>
</div>

<script>
/* ------------------------------------------------------------
   1) Map
------------------------------------------------------------ */
const map = L.map("map", { zoomControl:true }).setView([44.2, -96.5], 6);

const osm = L.tileLayer(
  "https://{s}.basemaps.cartocdn.com/light_nolabels/{z}/{x}/{y}{r}.png",
  { attribution: "© OpenStreetMap © CARTO", subdomains:"abcd", maxZoom: 19 }
).addTo(map);

// Optional label tiles (Carto light labels)
const labels = L.tileLayer(
  "https://{s}.basemaps.cartocdn.com/light_only_labels/{z}/{x}/{y}{r}.png",
  { attribution: "", subdomains:"abcd", maxZoom: 19, pane: "overlayPane" }
).addTo(map);

// --- Extra Midwest city labels (shows more as you zoom in) ---
const cityLabelLayer = L.layerGroup().addTo(map);

function makeCityLabel(name, lat, lon){
  return L.marker([lat, lon], {
    interactive: false,
    icon: L.divIcon({
      className: "town-label",
      html: name,
      iconSize: null
    })
  });
}

const CITIES_TIER1 = [
  ["Sioux Falls", 43.5446, -96.7311],
  ["Minneapolis", 44.9778, -93.2650],
  ["Des Moines", 41.5868, -93.6250],
  ["Omaha", 41.2565, -95.9345],
  ["Kansas City", 39.0997, -94.5786],
  ["Rapid City", 44.0805, -103.2310],
  ["Denver", 39.7392, -104.9903]
];

const CITIES_TIER2 = [
  ["Fargo", 46.8772, -96.7898],
  ["Bismarck", 46.8083, -100.7837],
  ["Pierre", 44.3683, -100.3510],
  ["Brookings", 44.3114, -96.7984],
  ["Watertown", 44.8994, -97.1150],
  ["Rochester", 44.0121, -92.4802],
  ["Sioux City", 42.4990, -96.4003],
  ["Lincoln", 40.8136, -96.7026],
  ["St. Louis", 38.6270, -90.1994],
  ["Madison", 43.0731, -89.4012],
  ["Milwaukee", 43.0389, -87.9065],
  ["Chicago", 41.8781, -87.6298]
];

function updateCityLabels(){
  const z = map.getZoom();
  
  // --- Declutter strategy ---
  // - Use our custom white-bubble labels at mid zooms
  // - Switch to built-in map labels only when zoomed in far enough
  if (z >= 9) {
    if (!map.hasLayer(osmLabels)) osmLabels.addTo(map);
    if (map.hasLayer(cityLabelLayer)) map.removeLayer(cityLabelLayer);
  } else {
    if (map.hasLayer(osmLabels)) map.removeLayer(osmLabels);
    if (!map.hasLayer(cityLabelLayer)) cityLabelLayer.addTo(map);
  }

  cityLabelLayer.clearLayers();

  if (z < 6) { return; }

  if (z >= 4){
    CITIES_TIER1.forEach(c => cityLabelLayer.addLayer(makeCityLabel(c[0], c[1], c[2])));
  }
  if (z >= 6){
    CITIES_TIER2.forEach(c => cityLabelLayer.addLayer(makeCityLabel(c[0], c[1], c[2])));
  }
}
map.on("zoomend", updateCityLabels);
updateCityLabels();

// A few always-on towns (like before)
function addTown(name, lat, lon){
  L.marker([lat, lon], {
    icon: L.divIcon({ className:"town-label", html: name, iconSize: null }),
    interactive:false
  }).addTo(cityLabelLayer);
}
addTown("Omaha", 41.2565, -95.9345);
addTown("Des Moines", 41.5868, -93.6250);
addTown("Minneapolis", 44.9778, -93.2650);
addTown("Kansas City", 39.0997, -94.5786);
addTown("St. Louis", 38.6270, -90.1994);
map.attributionControl.setPrefix(false);

const statusEl    = document.getElementById("status");
const timeLabelEl = document.getElementById("timeLabel");
const dayLabelEl  = document.getElementById("dayLabel");
const zoomLabelEl = document.getElementById("zoomLabel");

function setStatus(msg){ statusEl.textContent = msg; }

map.on("zoomend", ()=>zoomLabelEl.textContent = String(map.getZoom()));
zoomLabelEl.textContent = String(map.getZoom());

/* ------------------------------------------------------------
   2) Time controls (METAR + Alerts)
------------------------------------------------------------ */
let current = new Date(Date.UTC(2018, 3, 14, 15, 0, 0)); // default (will snap to timeline)
const stepHours = 3;

// Alerts timeline index (optional, but recommended)
let ALERTS_TIMELINE = null; // array of {t, file, count}
let ALERTS_MIN = null;
let ALERTS_MAX = null;

function parseISOZ(s){
  // '2018-04-12T00:00:00Z' -> Date
  const d = new Date(s);
  return isNaN(d.getTime()) ? null : d;
}

async function loadAlertsTimelineIndex(){
  try {
    const r = await fetch('./timeline_index.json', { cache:'no-store' });
    if (!r.ok) throw new Error('HTTP ' + r.status);
    const idx = await r.json();
    if (!Array.isArray(idx) || !idx.length) throw new Error('empty index');
    ALERTS_TIMELINE = idx
      .map(x => ({...x, _d: parseISOZ(x.t)}))
      .filter(x => x._d);
    ALERTS_TIMELINE.sort((a,b)=>a._d-b._d);
    ALERTS_MIN = ALERTS_TIMELINE[0]._d;
    ALERTS_MAX = ALERTS_TIMELINE[ALERTS_TIMELINE.length-1]._d;
  } catch(e){
    // Not fatal: we'll fall back to the old per-hour filenames
    console.warn('No timeline_index.json found or unreadable:', e.message);
    ALERTS_TIMELINE = null;
    ALERTS_MIN = null;
    ALERTS_MAX = null;
  }
}

function snapCurrentToAlertsTimeline(){
  if (!ALERTS_TIMELINE || !ALERTS_TIMELINE.length) return null;
  // clamp
  if (current < ALERTS_MIN) current = new Date(ALERTS_MIN.getTime());
  if (current > ALERTS_MAX) current = new Date(ALERTS_MAX.getTime());
  // nearest
  let best = ALERTS_TIMELINE[0];
  let bestDt = Math.abs(current - best._d);
  for (let i=1;i<ALERTS_TIMELINE.length;i++){
    const it = ALERTS_TIMELINE[i];
    const dt = Math.abs(current - it._d);
    if (dt < bestDt){ best = it; bestDt = dt; }
  }
  // snap label/time to the actual frame time to avoid confusing 'out of range' times
  current = new Date(best._d.getTime());
  return best;
}


function fmtZ(d){
  const Y = d.getUTCFullYear();
  const M = String(d.getUTCMonth()+1).padStart(2,"0");
  const D = String(d.getUTCDate()).padStart(2,"0");
  const H = String(d.getUTCHours()).padStart(2,"0");
  return `${Y}-${M}-${D} ${H}Z`;
}
function toISOZ(d){
  const Y = d.getUTCFullYear();
  const M = String(d.getUTCMonth()+1).padStart(2,"0");
  const D = String(d.getUTCDate()).padStart(2,"0");
  const H = String(d.getUTCHours()).padStart(2,"0");
  return `${Y}-${M}-${D}T${H}:00:00Z`;
}

function formatCentralLabel(dUtc) {
  // Display in "Central time" without DST complexity for students.
  // April is technically CDT, but we keep a fixed -5 hour offset for clarity.
  const central = new Date(dUtc.getTime() - 5*3600*1000); // UTC -> Central (approx)
  const months = ["January","February","March","April","May","June","July","August","September","October","November","December"];
  const m = months[central.getUTCMonth()];
  const day = central.getUTCDate();
  const year = central.getUTCFullYear();
  let hr = central.getUTCHours();
  const ampm = hr >= 12 ? "PM" : "AM";
  hr = hr % 12; if (hr === 0) hr = 12;
  return `${m} ${day}, ${year} ${hr}${ampm}`;
}

function updateTimeLabel(){
  timeLabelEl.textContent = fmtZ(current);
  const bt = document.getElementById("bannerTimeLabel");
  if (bt) bt.textContent = formatCentralLabel(current);
}
updateTimeLabel();

// Try to load alerts timeline index (if present in repo)
loadAlertsTimelineIndex().then(()=>{
  snapCurrentToAlertsTimeline();
  updateTimeLabel();
});

document.getElementById("backBtn").onclick = async () => {
  current = new Date(current.getTime() - stepHours*3600*1000);
  snapCurrentToAlertsTimeline();
  updateTimeLabel();
  await refreshAll();
};
document.getElementById("fwdBtn").onclick = async () => {
  current = new Date(current.getTime() + stepHours*3600*1000);
  snapCurrentToAlertsTimeline();
  updateTimeLabel();
  await refreshAll();
};

// Mirror controls to the master banner (from index 15)
const backBtnBanner = document.getElementById("backBtnBanner");
const fwdBtnBanner  = document.getElementById("fwdBtnBanner");
if (backBtnBanner) backBtnBanner.onclick = document.getElementById("backBtn").onclick;
if (fwdBtnBanner)  fwdBtnBanner.onclick  = document.getElementById("fwdBtn").onclick;

const zoomOutBtnBanner = document.getElementById("zoomOutBtnBanner");
const zoomInBtnBanner  = document.getElementById("zoomInBtnBanner");
if (zoomOutBtnBanner) zoomOutBtnBanner.onclick = () => map.zoomOut();
if (zoomInBtnBanner)  zoomInBtnBanner.onclick  = () => map.zoomIn();



/* ------------------------------------------------------------
   3) Day controls (Particles only: Apr 13/14/15)
------------------------------------------------------------ */
let particleDay = 14; // 13, 14, 15
function updateDayLabel(){
  dayLabelEl.textContent = (particleDay === 13) ? "Apr 13" : (particleDay === 15) ? "Apr 15" : "Apr 14";
}
updateDayLabel();

document.getElementById("dayBackBtn").onclick = async () => {
  particleDay = Math.max(13, particleDay - 1);
  updateDayLabel();
  await refreshParticlesIfOn();
};
document.getElementById("dayFwdBtn").onclick = async () => {
  particleDay = Math.min(15, particleDay + 1);
  updateDayLabel();
  await refreshParticlesIfOn();
};

/* ------------------------------------------------------------
   4) Layers
------------------------------------------------------------ */
const tempLayer = L.layerGroup().addTo(map);
const dewLayer  = L.layerGroup();
const windNumLayer = L.layerGroup();
const windArrowLayer = L.layerGroup();
const gustLayer = L.layerGroup();
const visLayer  = L.layerGroup();
const presLayer = L.layerGroup();
const wxLayer   = L.layerGroup();

// Alerts
const alertsLayer = L.geoJSON(null);

// Particles: placeholder for checkbox + actual velocity layer
const particlesToggle = L.layerGroup();
let particlesLayer = null;

L.control.layers(
  { "OpenStreetMap": osm },
  {
    "Temperature (°F)": tempLayer,
    "Dew Point (°F)": dewLayer,
    "Wind Speed (mph)": windNumLayer,
    "Wind Arrows": windArrowLayer,
    "Wind Gusts (mph)": gustLayer,
    "Visibility (mi)": visLayer,
    "Pressure (trend)": presLayer,
    "Weather Codes": wxLayer,
    "Alerts (WWA)": alertsLayer,
    "Daily wind particles": particlesToggle
  },
  { collapsed:false }
).addTo(map);

/* ------------------------------------------------------------
   5) Collision thinning (drop stations if overlapping)
------------------------------------------------------------ */
class CollisionIndex {
  constructor(cellSizePx){
    this.cell = cellSizePx;
    this.grid = new Map();
  }
  _key(cx, cy){ return `${cx},${cy}`; }
  _cellOf(p){ return [Math.floor(p.x / this.cell), Math.floor(p.y / this.cell)]; }
  canPlace(p, minSepPx){
    const [cx, cy] = this._cellOf(p);
    const r2 = minSepPx * minSepPx;
    for (let dx=-1; dx<=1; dx++){
      for (let dy=-1; dy<=1; dy++){
        const key = this._key(cx+dx, cy+dy);
        const arr = this.grid.get(key);
        if (!arr) continue;
        for (const q of arr){
          const ddx = p.x - q.x;
          const ddy = p.y - q.y;
          if ((ddx*ddx + ddy*ddy) < r2) return false;
        }
      }
    }
    const key = this._key(cx, cy);
    if (!this.grid.has(key)) this.grid.set(key, []);
    this.grid.get(key).push({x:p.x, y:p.y});
    return true;
  }
}

function minSepForZoom(z){
  if (z <= 4) return 54;
  if (z === 5) return 46;
  if (z === 6) return 38;
  if (z === 7) return 32;
  return 0; // z >= 8 show all
}
function allowByCollision(index, lat, lon, minSepPx){
  if (minSepPx <= 0) return true;
  const p = map.latLngToLayerPoint([lat, lon]);
  return index.canPlace(p, minSepPx);
}

/* ------------------------------------------------------------
   6) Color ramps
------------------------------------------------------------ */
function piecewiseColor(x, stops){
  if (x == null || !Number.isFinite(x)) return "rgb(255,255,255)";
  if (x <= stops[0].v) return `rgb(${stops[0].c.join(",")})`;
  if (x >= stops[stops.length-1].v) return `rgb(${stops[stops.length-1].c.join(",")})`;
  for (let i=0; i<stops.length-1; i++){
    const a = stops[i], b = stops[i+1];
    if (x >= a.v && x <= b.v){
      const k = (x - a.v) / (b.v - a.v);
      const r = Math.round(a.c[0] + (b.c[0]-a.c[0]) * k);
      const g = Math.round(a.c[1] + (b.c[1]-a.c[1]) * k);
      const bb= Math.round(a.c[2] + (b.c[2]-a.c[2]) * k);
      return `rgb(${r},${g},${bb})`;
    }
  }
  return "rgb(255,255,255)";
}

function tempColorF(t){
  return piecewiseColor(t, [
    {v: 10, c: [170, 220, 255]},
    {v: 20, c: [120, 190, 255]},
    {v: 30, c: [0, 70, 200]},
    {v: 40, c: [0, 170, 0]},
    {v: 50, c: [150, 255, 150]},
    {v: 60, c: [255, 235, 0]},
    {v: 70, c: [255, 140, 0]},
    {v: 85, c: [255, 80, 0]}
  ]);
}

function dewColorF(td){
  return piecewiseColor(td, [
    {v: 10, c: [90, 55, 20]},
    {v: 20, c: [140, 95, 40]},
    {v: 30, c: [200, 160, 110]},
    {v: 50, c: [190, 200, 140]},
    {v: 60, c: [0, 170, 0]},
    {v: 70, c: [0, 90, 0]}
  ]);
}

function windColorMph(spd){
  return piecewiseColor(spd, [
    {v: 0,  c: [0, 40, 160]},
    {v: 10, c: [0, 120, 255]},
    {v: 20, c: [0, 210, 180]},
    {v: 35, c: [255, 220, 0]},
    {v: 50, c: [255, 120, 0]},
    {v: 70, c: [255, 80, 0]}
  ]);
}

function pressureTrendColor(deltaInHg){
  if (deltaInHg == null || !Number.isFinite(deltaInHg)) return "rgb(248,248,248)";
  if (deltaInHg > 0.02)  return "rgb(215,245,215)";
  if (deltaInHg < -0.02) return "rgb(255,220,220)";
  return "rgb(240,240,240)";
}

function visStyle(vis){
  if (vis == null || !Number.isFinite(vis)) {
    return { bg:"rgba(255,255,255,0.65)", border:"#333" };
  }
  const v = Math.max(0, Math.min(10, vis));
  const alpha = 1 - (v / 10);
  const border = (v < 1) ? "#666" : "#333";
  return { bg:`rgba(255,255,255,${alpha.toFixed(3)})`, border };
}

/* ------------------------------------------------------------
   7) Icons
------------------------------------------------------------ */
function dotIcon(txt, fill, size=28, fontSize=12, borderColor="#333"){
  return L.divIcon({
    className:"",
    html:`<div class="dot"
              style="width:${size}px;height:${size}px;
                     background:${fill};
                     border-color:${borderColor};
                     font-size:${fontSize}px;">${txt}</div>`,
    iconSize:[size,size],
    iconAnchor:[size/2,size/2]
  });
}

/* Wind arrow as inline SVG divIcon */
function windArrowIcon(bearingDeg, mph){
  const spd = (mph == null || !Number.isFinite(mph)) ? 0 : mph;
  const color = windColorMph(spd);

  const Lmin = 14, Lmax = 52;
  const len = Math.max(Lmin, Math.min(Lmax, Lmin + spd * 0.65));

  const w = 60, h = 60;
  const cx = w/2, cy = h/2;

  const svg = `
    <svg width="${w}" height="${h}" viewBox="0 0 ${w} ${h}">
      <g transform="translate(${cx},${cy})">
        <line x1="0" y1="${len/2}" x2="0" y2="${-len/2}" stroke="${color}" stroke-width="4" stroke-linecap="round"/>
        <polygon points="0,${-len/2-8} -8,${-len/2+6} 8,${-len/2+6}" fill="${color}"/>
      </g>
    </svg>
  `;

  return L.divIcon({
    className:"",
    html:`<div style="width:${w}px;height:${h}px;transform:rotate(${bearingDeg}deg);">
            ${svg}
          </div>`,
    iconSize:[w,h],
    iconAnchor:[w/2,h/2]
  });
}

/* ------------------------------------------------------------
   8) Helpers
------------------------------------------------------------ */
function num(v){
  const s = (v ?? "").toString().trim();
  if (!s) return null;
  const n = Number(s);
  return Number.isFinite(n) ? n : null;
}
function ktToMph(kt){ return kt == null ? null : (kt * 1.15078); }

function parseVisMiles(raw){
  if (raw == null) return { miles:null, label:"" };
  let s = String(raw).trim();
  if (!s) return { miles:null, label:"" };

  if (s.startsWith("M")) s = s.slice(1);
  s = s.replace(/\s+/g, " ");

  const n = Number(s);
  if (Number.isFinite(n)) return { miles:n, label:formatVisLabel(n) };

  const parts = s.split(" ");
  let whole = 0;
  let frac = null;

  if (parts.length === 2){
    whole = Number(parts[0]);
    frac = parts[1];
  } else {
    frac = parts[0];
  }

  if (frac && frac.includes("/")){
    const [a,b] = frac.split("/").map(Number);
    if (Number.isFinite(a) && Number.isFinite(b) && b !== 0){
      const val = (Number.isFinite(whole) ? whole : 0) + (a/b);
      return { miles:val, label:formatVisLabel(val) };
    }
  }
  return { miles:null, label:String(raw).trim() };
}
function formatVisLabel(x){
  if (!Number.isFinite(x)) return "";
  if (x >= 10) return "10+";

  const denom = 8;
  const whole = Math.floor(x);
  const frac = x - whole;
  const nume = Math.round(frac * denom);

  if (nume === 0) return String(whole);
  if (nume === denom) return String(whole + 1);

  const gcd = (a,b)=>b?gcd(b,a%b):a;
  const g = gcd(nume, denom);
  const n = nume / g;
  const d = denom / g;

  if (whole === 0) return `${n}/${d}`;
  return `${whole} ${n}/${d}`;
}

function popupHTML(r, dAlt){
  const tmp = num(r.tmpf);
  const dew = num(r.dwpf);
  const drct = num(r.drct);
  const sknt = num(r.sknt);
  const gust = num(r.gust);
  const alti = num(r.alti);

  const mph  = sknt != null ? Math.round(ktToMph(sknt)) : "—";
  const gmh  = gust != null ? Math.round(ktToMph(gust)) : "—";
  const altTxt = alti != null ? alti.toFixed(2) : "—";
  const dTxt = (dAlt == null) ? "—" : `${dAlt > 0 ? "+" : ""}${dAlt.toFixed(2)} in/3h`;

  const visObj = parseVisMiles(r.vsby);
  const visTxt = (visObj.label || r.vsby || "—");

  const toDir = (drct != null) ? ((drct + 180) % 360) : null;

  return `
    <div style="font:600 13px/1.3 Arial,sans-serif">
      <div style="font-size:14px;margin-bottom:4px"><b>${r.station || "Station"}</b></div>
      <div style="opacity:.85;margin-bottom:6px">Valid: ${r.valid || ""} UTC</div>
      <div>Temp: <b>${tmp == null ? "—" : Math.round(tmp)}</b> °F</div>
      <div>Dew Pt: <b>${dew == null ? "—" : Math.round(dew)}</b> °F</div>
      <div>Wind: <b>${mph}</b> mph (gust <b>${gmh}</b>)</div>
      <div>Wind dir (FROM): <b>${drct == null ? "—" : drct.toFixed(0)}°</b></div>
      <div>Arrow points (TO): <b>${toDir == null ? "—" : toDir.toFixed(0)}°</b></div>
      <div>Vis: <b>${visTxt}</b> mi</div>
      <div>Altimeter: <b>${altTxt}</b> inHg</div>
      <div>Alt trend (3h): <b>${dTxt}</b></div>
      <div>Wx: <b>${(r.wxcodes || "").trim() || "—"}</b></div>
    </div>
  `;
}

/* ------------------------------------------------------------
   9) METAR fetch
------------------------------------------------------------ */
const reportType = 3;
const SD_ONLY = ["SD_ASOS"];
const REST = ["MN_ASOS","IA_ASOS","NE_ASOS","ND_ASOS","WI_ASOS","IL_ASOS","MI_ASOS"];

function asosURL(d, networks){
  const iso = toISOZ(d);
  return "https://mesonet.agron.iastate.edu/cgi-bin/request/asos.py"
    + "?data=tmpf&data=dwpf&data=drct&data=sknt&data=gust&data=vsby&data=alti&data=wxcodes"
    + `&network=${encodeURIComponent(networks.join(","))}`
    + `&report_type=${reportType}`
    + "&latlon=yes&format=onlycomma&tz=UTC"
    + `&sts=${encodeURIComponent(iso)}`
    + `&ets=${encodeURIComponent(iso)}`
    + "&missing=empty";
}

function parseCSV(text){
  const lines = text.split(/\r?\n/).filter(l => l.trim() && !l.startsWith("#"));
  if (lines.length < 2) return [];
  const header = lines[0].split(",");
  return lines.slice(1).map(line => {
    const cols = line.split(",");
    const obj = {};
    header.forEach((h,i)=>obj[h]=cols[i] ?? "");
    return obj;
  });
}

async function fetchRows(d, networks){
  const resp = await fetch(asosURL(d, networks), { cache:"no-store" });
  if (!resp.ok) throw new Error(`METAR HTTP ${resp.status}`);
  return parseCSV(await resp.text());
}

/* ------------------------------------------------------------
   10) Alerts styling + LOADER (UPDATED for your new filenames)
------------------------------------------------------------ */
const NWS_EVENT_COLOR = {
  // Severe / Flood (from NWS Hazards Map colors)
  "Tornado Warning": "#FF0000",
  "Severe Thunderstorm Warning": "#FFA500",
  "Flash Flood Warning": "#8B0000",
  "Flash Flood Watch": "#2E8B57",
  "Flood Warning": "#00FF00",
  "Flood Advisory": "#00FF7F",
  "Flood Watch": "#2E8B57",

  // Winter
  "Blizzard Warning": "#FF4500",
  "Winter Storm Warning": "#FF69B4",
  "Winter Storm Watch": "#4682B4",
  "Winter Weather Advisory": "#7B68EE",
  "Ice Storm Warning": "#8B008B",
  "Snow Squall Warning": "#C71585",

  // Wind / Other
  "High Wind Warning": "#DAA520",
  "Wind Advisory": "#D2B48C",
  "Dense Fog Advisory": "#708090"
};

function pickProp(p, keys){
  if (!p) return "";
  for (const k of keys){
    if (p[k] != null && String(p[k]).trim() !== "") return String(p[k]).trim();
    const kk = Object.keys(p).find(x => x.toLowerCase() === k.toLowerCase());
    if (kk && p[kk] != null && String(p[kk]).trim() !== "") return String(p[kk]).trim();
  }
  return "";
}

function eventNameFromProps(p){
  const e = pickProp(p, ["event","headline","name","title"]);
  if (e) return e;

  const phen = pickProp(p, ["phenomena","phenom","PHENOM","phen"]);
  const sig  = pickProp(p, ["significance","sig","SIG"]);
  if (phen && sig){
    const key = `${phen}.${sig}`.toUpperCase();
    // Common VTEC phenom.sig -> human name
    const MAP = {
      'BZ.W':'Blizzard Warning',
      'WS.W':'Winter Storm Warning',
      'WS.A':'Winter Storm Watch',
      'WW.Y':'Winter Weather Advisory',
      'ZR.Y':'Freezing Rain Advisory',
      'IS.W':'Ice Storm Warning',
      'SQ.W':'Snow Squall Warning',

      'TO.W':'Tornado Warning',
      'TO.A':'Tornado Watch',
      'SV.W':'Severe Thunderstorm Warning',
      'SV.A':'Severe Thunderstorm Watch',
      'FF.W':'Flash Flood Warning',
      'FF.A':'Flash Flood Watch',
      'FA.W':'Flood Warning',
      'FA.Y':'Flood Advisory',
      'FL.W':'Flood Warning',
      'FL.Y':'Flood Advisory',

      'MA.W':'Marine Warning',
      'GL.W':'Gale Warning',
      'SR.W':'Storm Warning'
    };
    if (MAP[key]) return MAP[key];
    return key;
  }

  const wfo = pickProp(p, ["WFO","wfo"]);
  const etn = pickProp(p, ["ETN","etn"]);
  return (wfo || etn) ? `Alert ${wfo || ""} ${etn || ""}`.trim() : "Alert";
}

function colorForAlertName(name){
  if (NWS_EVENT_COLOR[name]) return NWS_EVENT_COLOR[name];
  const lower = String(name).toLowerCase();
  if (lower.includes("blizzard") && lower.includes("warning")) return NWS_EVENT_COLOR["Blizzard Warning"];
  if (lower.includes("winter storm") && lower.includes("warning")) return NWS_EVENT_COLOR["Winter Storm Warning"];
  if (lower.includes("winter storm") && lower.includes("watch")) return NWS_EVENT_COLOR["Winter Storm Watch"];
  if (lower.includes('winter weather') && lower.includes('advisory')) return NWS_EVENT_COLOR['Winter Weather Advisory'];
  if (lower.includes('tornado') && lower.includes('warning')) return NWS_EVENT_COLOR['Tornado Warning'];
  if (lower.includes('tornado') && lower.includes('watch')) return NWS_EVENT_COLOR['Tornado Watch'];
  if (lower.includes('severe thunderstorm') && lower.includes('warning')) return NWS_EVENT_COLOR['Severe Thunderstorm Warning'];
  if (lower.includes('severe thunderstorm') && lower.includes('watch')) return NWS_EVENT_COLOR['Severe Thunderstorm Watch'];
  if (lower.includes('flash flood') && lower.includes('warning')) return NWS_EVENT_COLOR['Flash Flood Warning'];
  if (lower.includes('flash flood') && lower.includes('watch')) return NWS_EVENT_COLOR['Flash Flood Watch'];
  if (lower == 'flood warning') return NWS_EVENT_COLOR['Flood Warning'];
  if (lower == 'flood advisory') return NWS_EVENT_COLOR['Flood Advisory'];
  return '#CC0000'; // fallback

}

// NEW (your repo): alerts_20180414_0000Z.geojson
function alertsFileCompactHourly(d){
  const Y = d.getUTCFullYear();
  const M = String(d.getUTCMonth()+1).padStart(2,"0");
  const D = String(d.getUTCDate()).padStart(2,"0");
  const H = String(d.getUTCHours()).padStart(2,"0");
  return `./alerts_${Y}${M}${D}_${H}00Z.geojson`;
}

// OLD (your repo): alerts_2018-04-14T21Z.geojson
function alertsFileOldDash(d){
  const Y = d.getUTCFullYear();
  const M = String(d.getUTCMonth()+1).padStart(2,"0");
  const D = String(d.getUTCDate()).padStart(2,"0");
  const H = String(d.getUTCHours()).padStart(2,"0");
  return `./alerts_${Y}-${M}-${D}T${H}Z.geojson`;
}

// Extra fallback (sometimes people store T2100Z)
function alertsFileOldWithMinutes(d){
  const Y = d.getUTCFullYear();
  const M = String(d.getUTCMonth()+1).padStart(2,"0");
  const D = String(d.getUTCDate()).padStart(2,"0");
  const H = String(d.getUTCHours()).padStart(2,"0");
  return `./alerts_${Y}-${M}-${D}T${H}00Z.geojson`;
}

async function fetchFirstOk(urls){
  let lastErr = "";
  for (const u of urls){
    try{
      const r = await fetch(u, { cache:"no-store" });
      if (!r.ok) { lastErr = `HTTP ${r.status}`; continue; }
      const gj = await r.json();
      return { url: u, gj };
    } catch(e){
      lastErr = e.message || String(e);
    }
  }
  throw new Error(lastErr || "No alert file matched");
}

async function loadAlerts(){
  if (!map.hasLayer(alertsLayer)) return;

  // If you have a timeline_index.json + timeline_hourly/*.geojson, use it.
  const snapped = snapCurrentToAlertsTimeline();

  let candidates = [];
  if (snapped && snapped.file){
    candidates = [ './' + snapped.file.replace(/^\.\//, '') ];
  } else {
    // Backward compatibility: try legacy naming patterns
    candidates = [
      alertsFileCompactHourly(current),
      alertsFileOldDash(current),
      alertsFileOldWithMinutes(current)
    ];
  }

  try{
    const { url, gj } = await fetchFirstOk(candidates);

    alertsLayer.clearLayers();

    let polyCount = 0;
    L.geoJSON(gj, {
      style: (feat) => {
        const p = feat.properties || {};
        const name = eventNameFromProps(p);
        const c = colorForAlertName(name);
        return { weight:2, color:c, fillColor:c, fillOpacity:0.18 };
      },
      onEachFeature: (feat, layer) => {
        polyCount++;
        const p = feat.properties || {};
        const name = eventNameFromProps(p);
        const c = colorForAlertName(name);

        const wfo = pickProp(p, ['WFO','wfo']);
        const etn = pickProp(p, ['ETN','etn']);
        const status = pickProp(p, ['STATUS','status']);
        const issued = pickProp(p, ['issuance','issued','onset','ISSUANCE','ISSUED','ISSUE']);
        const expire = pickProp(p, ['expire','expires','end','EXPIRE','EXPIRES']);

        const lines = [];
        lines.push(`<div><span class="swatch" style="background:${c}"></span><b>${name}</b></div>`);
        if (wfo || etn) lines.push(`Office/Event: <b>${wfo || '—'}</b> / <b>${etn || '—'}</b>`);
        if (status) lines.push(`Status: <b>${status}</b>`);
        if (issued) lines.push(`Issued: <b>${issued}</b>`);
        if (expire) lines.push(`Expires: <b>${expire}</b>`);

        layer.bindPopup(lines.join('<br>'));
      }
    }).eachLayer(l => alertsLayer.addLayer(l));

    // Confirm which file loaded + how many polygons
    const short = url.replace('./','');
    setStatus(`Alerts loaded: ${short} | polygons: ${polyCount}`);

  } catch(e){
    console.warn('Alerts load failed:', e.message);
    alertsLayer.clearLayers();
    setStatus('Alerts not found for this hour (check filenames).');
  }
}

/* ------------------------------------------------------------
   11) Daily particles (toggle + day buttons)
------------------------------------------------------------ */
function particlesFileForDay(dayNum){
  return `./wind_particles_201804${String(dayNum).padStart(2,"0")}.json`;
}

function normalizeVelocityJson(raw){
  if (Array.isArray(raw)) return raw;
  if (raw && Array.isArray(raw.data)) return raw.data;
  return raw;
}

async function refreshParticlesIfOn(){
  if (!map.hasLayer(particlesToggle)) return;

  if (typeof L.velocityLayer !== "function"){
    setStatus("Wind particles: leaflet-velocity did not load.");
    return;
  }

  const url = particlesFileForDay(particleDay);

  try{
    const r = await fetch(url, { cache:"no-store" });
    if (!r.ok) throw new Error(`HTTP ${r.status}`);
    const raw = await r.json();
    const velData = normalizeVelocityJson(raw);

    if (particlesLayer){
      try { map.removeLayer(particlesLayer); } catch(_) {}
      particlesLayer = null;
    }

    particlesLayer = L.velocityLayer({
      data: velData,
      velocityScale: 0.004,
      particleAge: 120,
      particleMultiplier: 1/900,
      lineWidth: 1.7,
      colorScale: [
        "rgb(0,40,160)",
        "rgb(0,120,255)",
        "rgb(0,210,180)",
        "rgb(255,220,0)",
        "rgb(255,120,0)"
      ],
      minVelocity: 0,
      maxVelocity: 60,
      displayValues: false
    });

    particlesLayer.addTo(map);
    setStatus(`Particles loaded: ${url.replace("./","")}`);

  } catch(e){
    console.warn("Particles failed:", url, e.message);
    setStatus(`Particles not found: ${url.replace("./","")}`);
  }
}

/* Toggle handlers for particles + alerts */
map.on("overlayadd", async (e) => {
  if (e.layer === particlesToggle) await refreshParticlesIfOn();
  if (e.layer === alertsLayer) await loadAlerts();
});
map.on("overlayremove", (e) => {
  if (e.layer === particlesToggle && particlesLayer){
    map.removeLayer(particlesLayer);
    particlesLayer = null;
  }
});

/* ------------------------------------------------------------
   12) Main refresh (METAR + alerts + arrows)
------------------------------------------------------------ */
async function refreshAll(){
  setStatus("Loading METARs…");

  const prev = new Date(current.getTime() - stepHours*3600*1000);

  const [sdNow, restNow, sdPrev, restPrev] = await Promise.all([
    fetchRows(current, SD_ONLY),
    fetchRows(current, REST),
    fetchRows(prev, SD_ONLY),
    fetchRows(prev, REST)
  ]);

  const rowsNow  = sdNow.concat(restNow);
  const rowsPrev = sdPrev.concat(restPrev);

  const prevAlt = new Map();
  for (const r of rowsPrev){
    const st = (r.station || "").trim();
    const a  = num(r.alti);
    if (st && a != null) prevAlt.set(st, a);
  }

  [tempLayer, dewLayer, windNumLayer, windArrowLayer, gustLayer, visLayer, presLayer, wxLayer].forEach(l => l.clearLayers());

  const z = map.getZoom();
  const minSep = minSepForZoom(z);

  const idxTemp = new CollisionIndex(Math.max(24, minSep));
  const idxDew  = new CollisionIndex(Math.max(24, minSep));
  const idxWind = new CollisionIndex(Math.max(24, minSep));
  const idxGust = new CollisionIndex(Math.max(24, minSep));
  const idxVis  = new CollisionIndex(Math.max(24, minSep));
  const idxPres = new CollisionIndex(Math.max(24, minSep));
  const idxWx   = new CollisionIndex(Math.max(24, minSep));
  const idxArr  = new CollisionIndex(Math.max(30, minSep));

  let shown = 0, total = 0;

  for (const r of rowsNow){
    const lat = num(r.lat), lon = num(r.lon);
    if (lat == null || lon == null) continue;
    total++;

    const st = (r.station || "").trim();
    const alti = num(r.alti);
    const prevA = st ? prevAlt.get(st) : null;
    const dAlt = (alti != null && prevA != null) ? (alti - prevA) : null;

    const popup = popupHTML(r, dAlt);

    const tmp = num(r.tmpf);
    const dew = num(r.dwpf);

    const drct = num(r.drct);
    const sknt = num(r.sknt);
    const gust = num(r.gust);

    const mph  = sknt != null ? ktToMph(sknt) : null;
    const gmh  = gust != null ? ktToMph(gust) : null;

    const visObj = parseVisMiles(r.vsby);
    const visMi = visObj.miles;

    if (tmp != null && allowByCollision(idxTemp, lat, lon, minSep)){
      L.marker([lat,lon], { icon: dotIcon(String(Math.round(tmp)), tempColorF(tmp), 28, 12) })
        .bindPopup(popup).addTo(tempLayer);
    }

    if (dew != null && allowByCollision(idxDew, lat, lon, minSep)){
      L.marker([lat,lon], { icon: dotIcon(String(Math.round(dew)), dewColorF(dew), 28, 12) })
        .bindPopup(popup).addTo(dewLayer);
    }

    if (mph != null && allowByCollision(idxWind, lat, lon, minSep)){
      L.marker([lat,lon], { icon: dotIcon(String(Math.round(mph)), windColorMph(mph), 28, 12) })
        .bindPopup(popup).addTo(windNumLayer);
    }

    if (mph != null && drct != null && allowByCollision(idxArr, lat, lon, minSep)){
      const toDir = (drct + 180) % 360;
      L.marker([lat,lon], { icon: windArrowIcon(toDir, mph) })
        .bindPopup(popup).addTo(windArrowLayer);
    }

    if (gmh != null && allowByCollision(idxGust, lat, lon, minSep)){
      L.marker([lat,lon], { icon: dotIcon(String(Math.round(gmh)), windColorMph(gmh), 30, 12) })
        .bindPopup(popup).addTo(gustLayer);
    }

    if ((visObj.label || "").trim() && allowByCollision(idxVis, lat, lon, minSep)){
      const style = visStyle(visMi);
      L.marker([lat,lon], { icon: dotIcon(visObj.label, style.bg, 30, 11, style.border) })
        .bindPopup(popup).addTo(visLayer);
    }

    if (alti != null && allowByCollision(idxPres, lat, lon, minSep)){
      const fill = pressureTrendColor(dAlt);
      L.marker([lat,lon], { icon: dotIcon(alti.toFixed(2), fill, 44, 12, "#999") })
        .bindPopup(popup).addTo(presLayer);
    }

    const wx = (r.wxcodes || "").trim();
    if (wx && allowByCollision(idxWx, lat, lon, minSep)){
      L.marker([lat,lon], { icon: dotIcon(wx, "rgba(255,255,255,0.85)", 30, 10, "#999") })
        .bindPopup(popup).addTo(wxLayer);
    }

    shown++;
  }

  setStatus(`Stations shown: ${shown}/${total} (minSep ${minSep}px).`);

  await loadAlerts();
}

refreshAll().catch(err => {
  console.error(err);
  setStatus("Error: " + err.message);
});
</script>

<script>
  // Hook banner buttons to existing controls
  (function(){
    const back = document.getElementById('backBtn');
    const fwd  = document.getElementById('fwdBtn');
    const zb   = document.getElementById('zoomOutBtnBanner');
    const zi   = document.getElementById('zoomInBtnBanner');
    const bb   = document.getElementById('backBtnBanner');
    const fb   = document.getElementById('fwdBtnBanner');
    if (bb && back) bb.addEventListener('click', ()=> back.click());
    if (fb && fwd)  fb.addEventListener('click', ()=> fwd.click());
    if (zi) zi.addEventListener('click', ()=> map.zoomIn());
    if (zb) zb.addEventListener('click', ()=> map.zoomOut());
  })();
</script>

</body>
</html>
